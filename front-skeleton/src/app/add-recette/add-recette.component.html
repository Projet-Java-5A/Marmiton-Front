<div class="add-recette-container">

  <div class="form-container">
    <form [formGroup]="recetteForm" (ngSubmit)="onSubmit()" class="recette-form">
      <h2>Ajouter une nouvelle recette</h2>

      <mat-form-field appearance="fill">
        <mat-label>Nom de la recette</mat-label>
        <input matInput formControlName="name" required>
        <mat-error *ngIf="recetteForm.get('name')?.hasError('required')">
          Le nom est requis
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Ingrédients</mat-label>
        <mat-select formControlName="ingredients" multiple>
          <mat-option *ngFor="let ingredient of ingredientsList" [value]="ingredient">
            {{ ingredient.nom_ingredient }}
          </mat-option>
          <mat-option (click)="$event.stopPropagation(); openAddIngredient();" class="add-ingredient-option">
            <span class="add-option">+ Ajouter un nouvel ingrédient</span>
          </mat-option>
        </mat-select>
        <mat-error *ngIf="recetteForm.get('ingredients')?.hasError('required')">
          Au moins un ingrédient est requis
        </mat-error>
      </mat-form-field>

      <div *ngIf="showAddIngredientField" class="inline-add-ingredient">
        <mat-form-field appearance="fill">
          <mat-label>Nom de l'ingrédient</mat-label>
          <input matInput [(ngModel)]="newIngredientName" [ngModelOptions]="{standalone: true}">
        </mat-form-field>
        <button mat-stroked-button type="button" (click)="createIngredient()">Créer</button>
        <button mat-button type="button" (click)="showAddIngredientField=false">Annuler</button>
      </div>

      <div *ngIf="quantitiesFormArray.controls.length > 0" class="quantities-section" formArrayName="quantities">
        <h4>Quantités</h4>
        <div *ngFor="let quantityGroup of quantitiesFormArray.controls; let i = index" [formGroupName]="i" class="quantity-item">
          <span class="ingredient-name">{{ quantityGroup.value.ingredientName }}:</span>
          <mat-form-field appearance="outline" class="quantity-input">
            <mat-label>Quantité (ex: 100g, 2, ...)</mat-label>
            <input matInput formControlName="quantity" required>
          </mat-form-field>
        </div>
      </div>

      <mat-form-field appearance="fill">
        <mat-label>Ustensiles nécessaires</mat-label>
        <mat-select formControlName="ustensiles" multiple>
          <mat-option *ngFor="let ustensile of ustensilesList" [value]="ustensile">
            {{ ustensile.nomUstensileDto }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="recetteForm.get('ustensiles')?.hasError('required')">
          Au moins un ustensile est requis
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>URL de l'image</mat-label>
        <input matInput formControlName="image">
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Étapes de la recette</mat-label>
        <textarea matInput 
                  formControlName="steps" 
                  required 
                  cdkTextareaAutosize
                  #autosize="cdkTextareaAutosize"
                  cdkAutosizeMinRows="5"
                  cdkAutosizeMaxRows="20"></textarea>
        <mat-error *ngIf="recetteForm.get('steps')?.hasError('required')">
          Les étapes sont requises
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Durée de la recette (en minutes)</mat-label>
        <input matInput type="number" formControlName="dureeRecette" required>
        <mat-error *ngIf="recetteForm.get('dureeRecette')?.hasError('required')">
          La durée est requise
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Estimation du prix</mat-label>
        <mat-select formControlName="price" required>
          <mat-option *ngFor="let range of priceRanges" [value]="range">{{ range }}</mat-option>
        </mat-select>
        <mat-error *ngIf="recetteForm.get('price')?.hasError('required')">
          Le prix est requis
        </mat-error>
      </mat-form-field>

      <div class="difficulty-container">
        <label id="difficulty-label">Difficulté:</label>
        <div class="star-rating">
          <button mat-icon-button *ngFor="let star of stars" (click)="rate(star)" type="button">
            <mat-icon>{{ recetteForm.get('difficulty')?.value >= star ? 'star' : 'star_border' }}</mat-icon>
          </button>
        </div>
      </div>

      <button mat-raised-button color="primary" type="submit" [disabled]="!recetteForm.valid">
        Ajouter la recette
      </button>
    </form>
  </div>

  <div class="preview-container">
    <h4>Aperçu de l'image</h4>
    <img *ngIf="recetteForm.get('image')?.value" [src]="recetteForm.get('image')?.value" alt="Aperçu de la recette" class="image-preview">
  </div>
</div>
